<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Fireworks - Custom Backgrounds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .canvas-container-2d { /* For the 2D placement canvas */
            background-color: #1a1a1a;
            width: 100%;
            height: 350px; 
            max-width: 1342px; 
            margin: 0 auto;
            border: 1px solid #444;
            border-radius: 0.5rem;
            /* background-color will be handled by JS or fallback */
        }
        #threejs-canvas-container { /* For the 3D show canvas */
            width: 100%;
            height: 700px; 
            margin: 0 auto;
            /* background-color will be handled by JS or fallback */
            border-radius: 0.5rem;
            overflow: hidden; /* Ensure canvas fits */
        }
        #threejs-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .firework-item-in-list {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .firework-item-in-list.selected {
            background-color: #dbeafe; /* Tailwind blue-100 */
        }
        .color-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .color-input-wrapper input[type="color"] {
            width: 30px;
            height: 30px;
            padding: 0;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        .color-input-wrapper input[type="text"] {
            flex-grow: 1;
        }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe; margin: 15% auto; padding: 20px;
            border: 1px solid #888; width: 80%; max-width: 1400px;
            border-radius: 0.5rem; text-align: center;
        }
        .modal-close-button {
            background-color: #4CAF50; color: white; padding: 10px 20px;
            border: none; border-radius: 0.375rem; cursor: pointer; margin-top: 15px;
        }
    /* Dark-mode overrides */
    .bg-white { background-color: #1f1f1f !important; }
    .bg-gray-50 { background-color: #262626 !important; }
    p, label, h1, h2, h3, span { color: #e5e7eb !important; }
    input, button, select, textarea { background-color: #2d2d2d !important; border-color: #555 !important; color: #e5e7eb !important; }
    .modal-content { background-color: #222222 !important; color: #e5e7eb !important; }
    .shadow-lg { box-shadow: 0 8px 20px rgba(0,0,0,0.7) !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 antialiased">

    <div id="customAlertModal" class="modal">
        <div class="modal-content">
            <p id="customAlertMessage"></p>
            <button id="customAlertCloseButton" class="modal-close-button">OK</button>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <header class="mb-6 text-center">
            <h1 class="text-4xl font-bold text-indigo-600">Fireworks Show Creator</h1>
<p class="text-sm text-gray-400">Design in 2D, Preview in 3D!</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-1 bg-gray-800 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-500">1. Define Firework Types</h2>
                <form id="fireworkPropertiesForm" class="space-y-4">
                    <div>
                        <label for="fireworkName" class="block text-sm font-medium text-gray-700">Name:</label>
                        <input type="text" id="fireworkName" value="My Firework" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </div>
                    <div>
                        <label for="burstHeight3D" class="block text-sm font-medium text-gray-700">3D Burst Height (units): <span id="burstHeight3DValue">250</span></label>
                        <input type="range" id="burstHeight3D" min="50" max="500" value="250" class="mt-1 block w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label for="burstRadius3D" class="block text-sm font-medium text-gray-700">3D Burst Radius (units): <span id="burstRadius3DValue">75</span></label>
                        <input type="range" id="burstRadius3D" min="10" max="150" value="75" class="mt-1 block w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                    <p class="text-sm font-medium text-gray-700">Burst Colors (up to 4):</p>
                    <div id="burstColorsContainer" class="space-y-2">
                        </div>
                    <button type="button" id="addBurstColorButton" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">+ Add Color</button>

                    <div>
                        <label for="rocketSpeed3D" class="block text-sm font-medium text-gray-700">3D Rocket Speed (1-5): <span id="rocketSpeed3DValue">2.5</span></label>
                        <input type="range" id="rocketSpeed3D" min="1" max="5" step="0.1" value="2.5" class="mt-1 block w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <input type="hidden" id="editingFireworkTypeId">
                    <button type="submit" id="addOrUpdateFireworkTypeButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">Add Firework Type</button>
                </form>

                <hr class="my-6">
                <h3 class="text-xl font-semibold mb-3 text-indigo-500">Defined Firework Types</h3>
                <div id="fireworkTypesList" class="space-y-2 max-h-60 overflow-y-auto">
                    </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
<div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-indigo-500">2. Setup Show & 3. Preview</h2>
                        <div>
                            <button id="setupModeButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md mr-2">2D Setup</button>
                            <button id="showModeButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">3D Preview</button>
                        </div>
                    </div>

                    <div id="setupView">
                        <h3 class="text-xl font-semibold mb-2">2D Placement Area (Top-Down View)</h3>
                        <div class="canvas-container-2d">
                            <canvas id="placementCanvas2D"></canvas>
                        </div>
                        <div class="mt-4">
                            <label for="fireworkTiming" class="block text-sm font-medium text-gray-700">Selected Firework Timing (ms from start):</label>
                            <input type="number" id="fireworkTiming" value="0" min="0" step="100" class="mt-1 block w-full md:w-1/2 rounded-md border-gray-300 shadow-sm p-2">
                            <p class="mt-1 text-xs text-gray-500">Select a firework type and click on the canvas to place it.</p>
                        </div>
                        <hr class="my-4">
                        <h3 class="text-xl font-semibold mb-2">Placed Fireworks</h3>
                        <div id="placedFireworksList" class="space-y-2 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-md">
                            <p class="text-gray-500 text-sm">No fireworks placed yet.</p>
                        </div>
                    </div>

                    <div id="showView" class="hidden">
                        <h3 class="text-xl font-semibold mb-2">3D Show Preview</h3>
                         <div id="threejs-canvas-container">
                            <canvas id="threejs-canvas"></canvas>
                        </div>
                        <button id="play3DShowButton" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md">Play 3D Show</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';

        // --- Custom Alert Modal ---
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertCloseButton = document.getElementById('customAlertCloseButton');

        function showAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'block';
        }
        customAlertCloseButton.onclick = function() { customAlertModal.style.display = 'none'; }
        window.onclick = function(event) { if (event.target == customAlertModal) customAlertModal.style.display = 'none'; }

        // --- Global State & Configuration (2D Part) ---
        let fireworkTypes = []; 
        let placedFireworks2D = []; 
        let currentMode = 'setup'; 
        let selectedFireworkTypeIdForPlacement = null;
        const MAX_BURST_COLORS = 4;
        let placementBgImage2D = new Image();
        let placementBgImageLoaded2D = false;


        // --- DOM Elements (2D Part) ---
        const fireworkPropertiesForm = document.getElementById('fireworkPropertiesForm');
        const fireworkNameInput = document.getElementById('fireworkName');
        const burstHeight3DInput = document.getElementById('burstHeight3D'); 
        const burstHeight3DValueDisplay = document.getElementById('burstHeight3DValue'); 
        const burstRadius3DInput = document.getElementById('burstRadius3D'); 
        const burstRadius3DValueDisplay = document.getElementById('burstRadius3DValue'); 
        const burstColorsContainer = document.getElementById('burstColorsContainer');
        const addBurstColorButton = document.getElementById('addBurstColorButton');
        const rocketSpeed3DInput = document.getElementById('rocketSpeed3D'); 
        const rocketSpeed3DValueDisplay = document.getElementById('rocketSpeed3DValue'); 
        const addOrUpdateFireworkTypeButton = document.getElementById('addOrUpdateFireworkTypeButton');
        const editingFireworkTypeIdInput = document.getElementById('editingFireworkTypeId');
        const fireworkTypesListDiv = document.getElementById('fireworkTypesList');
        
        const setupModeButton = document.getElementById('setupModeButton');
        const showModeButton = document.getElementById('showModeButton');
        const setupView = document.getElementById('setupView');
        const showView = document.getElementById('showView');

        const placementCanvas2D = document.getElementById('placementCanvas2D');
        const placementCtx2D = placementCanvas2D.getContext('2d');
        const fireworkTimingInput = document.getElementById('fireworkTiming');
        const placedFireworksListDiv = document.getElementById('placedFireworksList');
        
        // --- 3D Scene Variables ---
        let threeScene, threeCamera, threeRenderer, threePlane, threeGridHelper, threeAxesHelper;
        const threeJsCanvas = document.getElementById('threejs-canvas');
        const threeJsCanvasContainer = document.getElementById('threejs-canvas-container');
        const threePlaneSize = 1000; 
        const threeOriginOffsetX = threePlaneSize / 2;
        const threeOriginOffsetZ = threePlaneSize / 2;
        let threeActiveFireworks = []; 
        let threeShowIsPlaying = false;
        const play3DShowButton = document.getElementById('play3DShowButton');

        const screenshotCameraPos_CenterRel = { x: 605.70, y: 315.31, z: 390.47 };
        const screenshotCameraRot_Euler = { x: -0.38, y: 0.87, z: 0.30 }; 
        const screenshotCameraLookAt_CenterRel = { x: -395.14, y: 0.00, z: -390.81 };

        const precise3DCameraPos = new THREE.Vector3(
            screenshotCameraPos_CenterRel.x + threeOriginOffsetX,
            screenshotCameraPos_CenterRel.y,
            screenshotCameraPos_CenterRel.z + threeOriginOffsetZ
        );
        const precise3DCameraLookAt = new THREE.Vector3(
            screenshotCameraLookAt_CenterRel.x + threeOriginOffsetX,
            screenshotCameraLookAt_CenterRel.y, 
            screenshotCameraLookAt_CenterRel.z + threeOriginOffsetZ
        );

        // Global 3D Fireworks animation parameters
        const GLOBAL_BURST_PARTICLES = 180;   
        const GLOBAL_BURST_DURATION = 250;    
        const GLOBAL_PARTICLE_LINGER_TIME = 0.35; 
        const GLOBAL_FLASH_DURATION = 30; 
        const GLOBAL_FLASH_MAX_SCALE = 2.8; 
        const GLOBAL_FLASH_INITIAL_SIZE_FACTOR = 0.25; 


        // --- Utility Functions (2D & General) ---
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

        // --- 2D Canvas Setup & Drawing ---
        function load2DPlacementBackground() {
            placementBgImage2D.onload = () => {
                placementBgImageLoaded2D = true;
                console.log("2D placement background (image_7fca77.png) loaded.");
                if (currentMode === 'setup') drawPlacementCanvas2D();
            };
            placementBgImage2D.onerror = () => {
                placementBgImageLoaded2D = false;
                console.warn("Failed to load 2D placement background (image_7fca77.png). Using fallback.");
                if (currentMode === 'setup') drawPlacementCanvas2D();
            };
            placementBgImage2D.src = 'image_7fca77.png'; // Attempt to load
        }

        function resize2DCanvas() {
            const container = placementCanvas2D.parentElement;
            if (container) {
                placementCanvas2D.width = container.clientWidth;
                placementCanvas2D.height = container.clientHeight > 0 ? container.clientHeight : 350;
            }
        }
        
        function drawPlacementCanvas2D() {
            if (!placementCtx2D) return;
            placementCtx2D.clearRect(0, 0, placementCanvas2D.width, placementCanvas2D.height);

            if (placementBgImageLoaded2D && placementBgImage2D.complete && placementBgImage2D.naturalWidth !== 0) {
                // Draw image_7fca77.png as background for 2D placement canvas
                const canvasAspect = placementCanvas2D.width / placementCanvas2D.height;
                const imageAspect = placementBgImage2D.naturalWidth / placementBgImage2D.naturalHeight;
                let sx = 0, sy = 0, sWidth = placementBgImage2D.naturalWidth, sHeight = placementBgImage2D.naturalHeight;
                let dx = 0, dy = 0, dWidth = placementCanvas2D.width, dHeight = placementCanvas2D.height;

                if (imageAspect > canvasAspect) { 
                    sHeight = placementBgImage2D.naturalHeight;
                    sWidth = sHeight * canvasAspect;
                    sx = (placementBgImage2D.naturalWidth - sWidth) / 2;
                } else if (imageAspect < canvasAspect) { 
                    sWidth = placementBgImage2D.naturalWidth;
                    sHeight = sWidth / canvasAspect;
                    sy = (placementBgImage2D.naturalHeight - sHeight) / 2;
                }
                placementCtx2D.drawImage(placementBgImage2D, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
            } else {
                placementCtx2D.fillStyle = '#e5e7eb'; // Fallback gray
                placementCtx2D.fillRect(0, 0, placementCanvas2D.width, placementCanvas2D.height);
            }

            // Draw placed fireworks on top
            placedFireworks2D.forEach(fw => {
                const type = fireworkTypes.find(t => t.id === fw.fireworkTypeId);
                if (!type) return;
                const x = fw.normalizedX * placementCanvas2D.width;
                const y = fw.normalizedY * placementCanvas2D.height;
                
                placementCtx2D.beginPath();
                placementCtx2D.arc(x, y, 6, 0, Math.PI * 2); 
                placementCtx2D.fillStyle = type.colors[0] || '#000000'; 
                placementCtx2D.fill();
                // Add a contrasting border for better visibility on various backgrounds
                placementCtx2D.strokeStyle = 'white'; 
                placementCtx2D.lineWidth = 1.5;
                placementCtx2D.stroke();
                placementCtx2D.strokeStyle = 'black';
                placementCtx2D.lineWidth = 0.5;
                placementCtx2D.stroke();
                placementCtx2D.closePath();

                placementCtx2D.fillStyle = 'black'; 
                placementCtx2D.font = 'bold 9px Inter';
                const text = `${fw.timing / 1000}s`;
                const textWidth = placementCtx2D.measureText(text).width;
                placementCtx2D.fillStyle = 'rgba(255, 255, 255, 0.7)'; 
                placementCtx2D.fillRect(x + 7, y - 8, textWidth + 4, 10);
                placementCtx2D.fillStyle = 'black'; 
                placementCtx2D.fillText(text, x + 9, y);
            });
        }

        // --- Firework Type Management (2D Part) ---
        // ... (renderFireworkTypesList, addBurstColorInput, resetFireworkForm, loadFireworkTypeForEditing, deleteFireworkType, form submit listener - remain the same) ...
        function renderFireworkTypesList() {
            fireworkTypesListDiv.innerHTML = '';
            if (fireworkTypes.length === 0) {
                fireworkTypesListDiv.innerHTML = '<p class="text-gray-500 text-sm">No firework types defined.</p>';
                return;
            }
            fireworkTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = `p-3 border rounded-md firework-item-in-list hover:bg-gray-100 ${type.id === selectedFireworkTypeIdForPlacement ? 'selected' : ''}`;
                div.dataset.id = type.id;
                const colorsPreview = type.colors.map(color => 
                    `<span style="display: inline-block; width: 12px; height: 12px; background-color: ${color}; border-radius: 50%; margin-right: 4px; border: 1px solid #ccc;"></span>`
                ).join('');
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-medium">${type.name} ${colorsPreview} (H:${type.burstHeight3D}, R:${type.burstRadius3D}, S:${type.rocketSpeed3D})</span>
                        <div>
                            <button class="edit-firework-type text-xs text-blue-500 hover:text-blue-700 mr-1" data-id="${type.id}">Edit</button>
                            <button class="delete-firework-type text-xs text-red-500 hover:text-red-700" data-id="${type.id}">Del</button>
                        </div>
                    </div>`;
                div.onclick = () => {
                    selectedFireworkTypeIdForPlacement = type.id;
                    renderFireworkTypesList(); 
                };
                fireworkTypesListDiv.appendChild(div);
            });
            document.querySelectorAll('.edit-firework-type').forEach(button => {
                button.addEventListener('click', (e) => { e.stopPropagation(); loadFireworkTypeForEditing(e.target.dataset.id); });
            });
            document.querySelectorAll('.delete-firework-type').forEach(button => {
                button.addEventListener('click', (e) => { e.stopPropagation(); deleteFireworkType(e.target.dataset.id); });
            });
        }

        function addBurstColorInput(colorValue = '#FF0000') {
            const colorInputs = burstColorsContainer.querySelectorAll('.burst-color-input-group');
            if (colorInputs.length >= MAX_BURST_COLORS) {
                addBurstColorButton.style.display = 'none';
                showAlert(`Maximum of ${MAX_BURST_COLORS} burst colors allowed.`);
                return;
            }
            const div = document.createElement('div');
            div.className = 'burst-color-input-group color-input-wrapper';
            const picker = document.createElement('input'); picker.type = 'color'; picker.value = colorValue;
            picker.className = 'p-1 h-10 w-10 block bg-white border border-gray-300 rounded-md cursor-pointer';
            const textInput = document.createElement('input'); textInput.type = 'text'; textInput.value = colorValue;
            textInput.placeholder = 'e.g., #RRGGBB'; textInput.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 burst-color-text';
            picker.oninput = () => textInput.value = picker.value;
            textInput.onchange = () => picker.value = textInput.value;
            const removeBtn = document.createElement('button'); removeBtn.type = 'button'; removeBtn.textContent = 'X';
            removeBtn.className = 'ml-2 text-red-500 hover:text-red-700 text-xs';
            removeBtn.onclick = () => { div.remove(); addBurstColorButton.style.display = 'inline-block'; };
            div.appendChild(picker); div.appendChild(textInput); div.appendChild(removeBtn);
            burstColorsContainer.appendChild(div);
            if (burstColorsContainer.querySelectorAll('.burst-color-input-group').length >= MAX_BURST_COLORS) {
                addBurstColorButton.style.display = 'none';
            }
        }
        
        function resetFireworkForm() {
            fireworkPropertiesForm.reset();
            burstHeight3DValueDisplay.textContent = burstHeight3DInput.value;
            burstRadius3DValueDisplay.textContent = burstRadius3DInput.value;
            rocketSpeed3DValueDisplay.textContent = rocketSpeed3DInput.value;
            burstColorsContainer.innerHTML = ''; addBurstColorInput('#FF0000');
            addBurstColorButton.style.display = 'inline-block';
            editingFireworkTypeIdInput.value = '';
            addOrUpdateFireworkTypeButton.textContent = 'Add Firework Type';
            fireworkNameInput.value = `FW Type ${fireworkTypes.length + 1}`;
        }

        function loadFireworkTypeForEditing(id) {
            const type = fireworkTypes.find(t => t.id === id);
            if (!type) return;
            fireworkNameInput.value = type.name;
            burstHeight3DInput.value = type.burstHeight3D; burstHeight3DValueDisplay.textContent = type.burstHeight3D;
            burstRadius3DInput.value = type.burstRadius3D; burstRadius3DValueDisplay.textContent = type.burstRadius3D;
            rocketSpeed3DInput.value = type.rocketSpeed3D; rocketSpeed3DValueDisplay.textContent = type.rocketSpeed3D;
            burstColorsContainer.innerHTML = ''; type.colors.forEach(color => addBurstColorInput(color));
            addBurstColorButton.style.display = burstColorsContainer.querySelectorAll('.burst-color-input-group').length < MAX_BURST_COLORS ? 'inline-block' : 'none';
            editingFireworkTypeIdInput.value = id;
            addOrUpdateFireworkTypeButton.textContent = 'Update Firework Type';
        }

        function deleteFireworkType(idToDelete) {
            fireworkTypes = fireworkTypes.filter(type => type.id !== idToDelete);
            placedFireworks2D = placedFireworks2D.filter(fw => fw.fireworkTypeId !== idToDelete);
            if (selectedFireworkTypeIdForPlacement === idToDelete) selectedFireworkTypeIdForPlacement = null;
            if (editingFireworkTypeIdInput.value === idToDelete) resetFireworkForm();
            renderFireworkTypesList(); renderPlacedFireworksList(); drawPlacementCanvas2D();
            showAlert('Firework type deleted.');
        }

        fireworkPropertiesForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = fireworkNameInput.value.trim();
            if (!name) { showAlert('Firework name cannot be empty.'); return; }
            const burstColors = Array.from(burstColorsContainer.querySelectorAll('.burst-color-text')).map(input => input.value.trim()).filter(color => color);
            if (burstColors.length === 0) { showAlert('At least one burst color is required.'); return; }
            
            const fireworkData = {
                name: name,
                burstHeight3D: parseInt(burstHeight3DInput.value),
                burstRadius3D: parseInt(burstRadius3DInput.value),
                colors: burstColors.map(c => c.startsWith('#') ? c : `#${c}`),
                rocketSpeed3D: parseFloat(rocketSpeed3DInput.value)
            };

            const editingId = editingFireworkTypeIdInput.value;
            if (editingId) {
                const index = fireworkTypes.findIndex(ft => ft.id === editingId);
                if (index > -1) fireworkTypes[index] = { ...fireworkTypes[index], ...fireworkData };
                showAlert('Firework type updated.');
            } else {
                fireworkData.id = generateId(); fireworkTypes.push(fireworkData);
                showAlert('Firework type added.');
            }
            renderFireworkTypesList(); resetFireworkForm(); drawPlacementCanvas2D();
        });

        // --- 2D Placement ---
        // ... (renderPlacedFireworksList and placementCanvas2D click listener - remain the same) ...
        function renderPlacedFireworksList() {
            placedFireworksListDiv.innerHTML = '';
            if (placedFireworks2D.length === 0) {
                placedFireworksListDiv.innerHTML = '<p class="text-gray-500 text-sm">No fireworks placed yet.</p>';
                return;
            }
            const sortedFireworks = [...placedFireworks2D].sort((a, b) => a.timing - b.timing);
            sortedFireworks.forEach(fw => {
                const type = fireworkTypes.find(t => t.id === fw.fireworkTypeId);
                const typeName = type ? type.name : 'Unknown';
                const div = document.createElement('div');
                div.className = 'p-2 border rounded-md bg-white text-sm flex justify-between items-center';
                div.innerHTML = `
                    <span><strong>${typeName}</strong> at ${fw.timing / 1000}s (Pos: ${(fw.normalizedX * 100).toFixed(0)}%,${(fw.normalizedY * 100).toFixed(0)}%)</span>
                    <button class="delete-placed-firework text-xs text-red-500 hover:text-red-700" data-id="${fw.id}">Remove</button>
                `;
                placedFireworksListDiv.appendChild(div);
            });
            document.querySelectorAll('.delete-placed-firework').forEach(button => {
                button.addEventListener('click', (e) => {
                    placedFireworks2D = placedFireworks2D.filter(pfw => pfw.id !== e.target.dataset.id);
                    renderPlacedFireworksList(); drawPlacementCanvas2D();
                });
            });
        }
        
        placementCanvas2D.addEventListener('click', (event) => {
            if (currentMode !== 'setup' || !selectedFireworkTypeIdForPlacement) {
                showAlert(!selectedFireworkTypeIdForPlacement ? 'Select a firework type first!' : 'Switch to Setup mode.');
                return;
            }
            const rect = placementCanvas2D.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const normalizedX = x / placementCanvas2D.width;
            const normalizedY = y / placementCanvas2D.height;
            const timing = parseInt(fireworkTimingInput.value);
            if (isNaN(timing) || timing < 0) { showAlert('Invalid timing value.'); return; }
            
            placedFireworks2D.push({
                id: generateId(), fireworkTypeId: selectedFireworkTypeIdForPlacement,
                normalizedX: normalizedX, normalizedY: normalizedY, timing: timing
            });
            renderPlacedFireworksList(); drawPlacementCanvas2D();
        });

        // --- Mode Switching ---
        function switchMode(mode) {
            currentMode = mode;
            if (mode === 'setup') {
                setupView.classList.remove('hidden'); showView.classList.add('hidden');
                setupModeButton.classList.add('bg-blue-700', 'font-bold'); setupModeButton.classList.remove('bg-blue-500');
                showModeButton.classList.add('bg-green-500'); showModeButton.classList.remove('bg-green-700', 'font-bold');
                resize2DCanvas(); drawPlacementCanvas2D(); // Redraw 2D canvas which might now have its background
            } else { // 'show' mode (3D)
                setupView.classList.add('hidden'); showView.classList.remove('hidden');
                showModeButton.classList.add('bg-green-700', 'font-bold'); showModeButton.classList.remove('bg-green-500');
                setupModeButton.classList.add('bg-blue-500'); setupModeButton.classList.remove('bg-blue-700', 'font-bold');
                init3DSceneIfNeeded(); 
            }
        }
        setupModeButton.addEventListener('click', () => switchMode('setup'));
        showModeButton.addEventListener('click', () => switchMode('show'));

        // --- 3D Scene Logic ---
        function init3DSceneIfNeeded() {
            if (!threeRenderer) { 
                threeScene = new THREE.Scene();
                // Default 3D background, may be overridden by texture
                threeScene.background = new THREE.Color(0x111122);

                threeCamera = new THREE.PerspectiveCamera(75, threeJsCanvasContainer.clientWidth / threeJsCanvasContainer.clientHeight, 0.1, 5000);
                threeCamera.position.copy(precise3DCameraPos);
                threeCamera.rotation.set(screenshotCameraRot_Euler.x, screenshotCameraRot_Euler.y, screenshotCameraRot_Euler.z);
                threeCamera.lookAt(precise3DCameraLookAt); 
                
                threeRenderer = new THREE.WebGLRenderer({ canvas: threeJsCanvas, antialias: true });
                threeRenderer.setPixelRatio(window.devicePixelRatio);
                
                // Attempt to load 3D background texture
                const textureLoader = new THREE.TextureLoader();
                textureLoader.load('background2.png',
                    texture => { // onLoad
                        console.log('3D scene background (background2.png) loaded.');
                        threeScene.background = texture;
                        if (threePlane && threePlane.parent) threeScene.remove(threePlane);
                        if (threeGridHelper && threeGridHelper.parent) threeScene.remove(threeGridHelper);
                        if (threeAxesHelper && threeAxesHelper.parent) threeScene.remove(threeAxesHelper);
                    },
                    undefined, // onProgress
                    err => { // onError
                        console.warn('Failed to load 3D scene background (background2.png). Using default color and ground.', err);
                        threeScene.background = new THREE.Color(0x111122); // Ensure fallback color
                        createDefault3DGround(); // Create ground if texture fails
                    }
                );
                

                threeAxesHelper = new THREE.AxesHelper(100);
                threeAxesHelper.position.set(0,0.02,0); 
                threeScene.add(threeAxesHelper);
                animate3D();
            }
            // Always resize renderer and update camera on mode switch or if already initialized
            threeRenderer.setSize(threeJsCanvasContainer.clientWidth, threeJsCanvasContainer.clientHeight);
            threeCamera.aspect = threeJsCanvasContainer.clientWidth / threeJsCanvasContainer.clientHeight;
            threeCamera.updateProjectionMatrix();
            render3D();
        }

        function createDefault3DGround() {
            // Only create if the scene background is the default color (not a texture)
            if (threeScene && threeScene.background instanceof THREE.Color) {
                if (!threePlane || !threePlane.parent) {
                    const planeGeometry = new THREE.PlaneGeometry(threePlaneSize, threePlaneSize);
                    const planeMaterial = new THREE.MeshBasicMaterial({ color: 0x282828, side: THREE.DoubleSide });
                    threePlane = new THREE.Mesh(planeGeometry, planeMaterial);
                    threePlane.rotation.x = -Math.PI / 2;
                    threePlane.position.set(threeOriginOffsetX, 0, threeOriginOffsetZ);
                    threeScene.add(threePlane);
                }
                if (!threeGridHelper || !threeGridHelper.parent) {
                    threeGridHelper = new THREE.GridHelper(threePlaneSize, 50, 0x383838, 0x383838);
                    threeGridHelper.position.set(threeOriginOffsetX, 0.01, threeOriginOffsetZ);
                    threeScene.add(threeGridHelper);
                }
            }
        }
        
        // ... (playActual3DShow, launch3DFirework, trigger3DBurst, animate3DFireworks - remain the same) ...
        function playActual3DShow() {
            if (threeShowIsPlaying || placedFireworks2D.length === 0) {
                showAlert(placedFireworks2D.length === 0 ? "No fireworks placed in 2D setup!" : "Show already playing.");
                return;
            }
            threeShowIsPlaying = true;
            threeActiveFireworks = [];
            console.log("Starting 3D fireworks show...");

            placedFireworks2D.forEach((fw2D) => {
                const type = fireworkTypes.find(t => t.id === fw2D.fireworkTypeId);
                if (!type) { console.warn(`Type not found for placed firework ${fw2D.id}`); return; }

                const worldX = fw2D.normalizedX * threePlaneSize;
                const worldZ = fw2D.normalizedY * threePlaneSize; 
                const startPosition3D = new THREE.Vector3(worldX, 0, worldZ); 

                setTimeout(() => {
                    if (!threeShowIsPlaying) return;
                    launch3DFirework(startPosition3D, type.colors, type.burstHeight3D, type.burstRadius3D, type.rocketSpeed3D);
                }, fw2D.timing);
            });

            const maxTiming = placedFireworks2D.length > 0 ? Math.max(0, ...placedFireworks2D.map(fw => fw.timing)) : 0;
            let longestFireworkDurationMs = 2000; 
            if (fireworkTypes.length > 0 && placedFireworks2D.length > 0) {
                const relevantTypes = placedFireworks2D.map(pfw => fireworkTypes.find(ft => ft.id === pfw.fireworkTypeId)).filter(Boolean);
                if (relevantTypes.length > 0) {
                    const typeForDurationCalc = relevantTypes.reduce((longest, current) => {
                        const currentDuration = (current.burstHeight3D / current.rocketSpeed3D) + GLOBAL_BURST_DURATION;
                        const longestDuration = (longest.burstHeight3D / longest.rocketSpeed3D) + GLOBAL_BURST_DURATION;
                        return currentDuration > longestDuration ? current : longest;
                    }, relevantTypes[0]);
                    longestFireworkDurationMs = ((typeForDurationCalc.burstHeight3D / typeForDurationCalc.rocketSpeed3D) + GLOBAL_BURST_DURATION) / 60 * 1000;
                }
            }
            
            const approxShowDurationMs = maxTiming + longestFireworkDurationMs;
            setTimeout(() => {
                threeShowIsPlaying = false;
                console.log("3D Fireworks show ended (approx).");
            }, approxShowDurationMs + 1500); 
        }
        play3DShowButton.addEventListener('click', playActual3DShow);


        function launch3DFirework(startPosition, fireworkColorsArray, fireworkBurstHeight, fireworkBurstRadius, fireworkRocketSpeed) {
            const rocketGeometry = new THREE.SphereGeometry(2.0, 8, 8); 
            const rocketMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, emissive: 0xffffee }); 
            const rocket = {
                type: 'rocket', mesh: new THREE.Mesh(rocketGeometry, rocketMaterial),
                startPos: startPosition.clone(), currentPos: startPosition.clone(),
                targetY: startPosition.y + fireworkBurstHeight, 
                colors: fireworkColorsArray, burstRadius: fireworkBurstRadius,
                speed: fireworkRocketSpeed, 
                life: 0 
            };
            rocket.mesh.position.copy(rocket.currentPos);
            threeScene.add(rocket.mesh);
            threeActiveFireworks.push(rocket);
        }

        function trigger3DBurst(position, particleColorsArray, particleBurstRadius) {
            const flashSize = particleBurstRadius * GLOBAL_FLASH_INITIAL_SIZE_FACTOR;
            const flashGeometry = new THREE.SphereGeometry(flashSize, 16, 16);
            const flashMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending });
            const flashMesh = new THREE.Mesh(flashGeometry, flashMaterial);
            flashMesh.position.copy(position);
            threeScene.add(flashMesh);
            threeActiveFireworks.push({
                type: 'flash', mesh: flashMesh, life: 0, duration: GLOBAL_FLASH_DURATION,
                maxScale: GLOBAL_FLASH_MAX_SCALE, initialSize: flashSize
            });

            const particleBurst = {
                type: 'burst', particles: [], origin: position.clone(),
                colors: particleColorsArray, radius: particleBurstRadius, 
                life: 0, duration: GLOBAL_BURST_DURATION 
            };
            for (let i = 0; i < GLOBAL_BURST_PARTICLES; i++) {
                const particleColor = particleColorsArray[i % particleColorsArray.length];
                const particleMesh = new THREE.Mesh(
                    new THREE.SphereGeometry(1.8 + Math.random() * 1.7, 6, 6),
                    new THREE.MeshBasicMaterial({ color: particleColor, transparent: true, opacity: 1.0 })
                );
                const speedFactor = particleBurstRadius / (particleBurst.duration * (1 - GLOBAL_PARTICLE_LINGER_TIME)); 
                const velocity = new THREE.Vector3((Math.random()-0.5), (Math.random()-0.5), (Math.random()-0.5)).normalize().multiplyScalar(speedFactor*(0.8+Math.random()*0.7)); 
                particleMesh.position.copy(position);
                threeScene.add(particleMesh);
                particleBurst.particles.push({ mesh: particleMesh, velocity: velocity });
            }
            threeActiveFireworks.push(particleBurst);
        }
        
        function animate3DFireworks() {
            for (let i = threeActiveFireworks.length - 1; i >= 0; i--) {
                const fw = threeActiveFireworks[i];
                fw.life++;
                if (fw.type === 'rocket') {
                    fw.currentPos.y += fw.speed; 
                    fw.mesh.position.y = fw.currentPos.y;
                    if (fw.currentPos.y >= fw.targetY) {
                        threeScene.remove(fw.mesh); fw.mesh.geometry.dispose(); fw.mesh.material.dispose();
                        trigger3DBurst(fw.currentPos.clone(), fw.colors, fw.burstRadius); 
                        threeActiveFireworks.splice(i, 1); 
                    }
                } else if (fw.type === 'flash') {
                    const progress = fw.life / fw.duration;
                    if (progress >= 1) {
                        threeScene.remove(fw.mesh); fw.mesh.geometry.dispose(); fw.mesh.material.dispose();
                        threeActiveFireworks.splice(i, 1); continue;
                    }
                    fw.mesh.scale.setScalar(1 + progress * (fw.maxScale -1));
                    fw.mesh.material.opacity = 0.9 * (1 - Math.pow(progress, 2)); 
                } else if (fw.type === 'burst') { 
                    if (fw.life >= fw.duration) { 
                        fw.particles.forEach(p => { threeScene.remove(p.mesh); p.mesh.geometry.dispose(); p.mesh.material.dispose(); });
                        threeActiveFireworks.splice(i, 1); continue;
                    }
                    const progress = fw.life / fw.duration;
                    fw.particles.forEach(p => {
                        p.mesh.position.add(p.velocity);
                        if (progress < GLOBAL_PARTICLE_LINGER_TIME) p.mesh.material.opacity = 1.0;
                        else p.mesh.material.opacity = Math.max(0, Math.pow(1.0 - ((progress - GLOBAL_PARTICLE_LINGER_TIME) / (1.0 - GLOBAL_PARTICLE_LINGER_TIME)), 0.75)); 
                        p.velocity.y -= 0.006; 
                        p.mesh.position.y = Math.max(0.1, p.mesh.position.y); 
                    });
                }
            }
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            if (threeShowIsPlaying) animate3DFireworks();
            render3D();
        }
        function render3D() { if(threeRenderer) threeRenderer.render(threeScene, threeCamera); }
        
        // --- Initial Setup (2D Part) ---
        window.addEventListener('DOMContentLoaded', () => {
            load2DPlacementBackground(); // Attempt to load 2D background
            switchMode('setup'); 
            addBurstColorInput('#FF0000'); 
            addBurstColorInput('#00FF00'); 
            renderFireworkTypesList();
            renderPlacedFireworksList();
            fireworkNameInput.value = `FW Type 1`;

            resize2DCanvas();
            // drawPlacementCanvas2D(); // Will be called by load2DPlacementBackground onload/onerror

            // Sliders
            burstHeight3DInput.addEventListener('input', (e) => burstHeight3DValueDisplay.textContent = e.target.value);
            burstRadius3DInput.addEventListener('input', (e) => burstRadius3DValueDisplay.textContent = e.target.value);
            rocketSpeed3DInput.addEventListener('input', (e) => rocketSpeed3DValueDisplay.textContent = e.target.value);
            addBurstColorButton.addEventListener('click', () => addBurstColorInput());
        });
        window.addEventListener('resize', () => {
            if (currentMode === 'setup') {
                resize2DCanvas(); drawPlacementCanvas2D();
            } else if (threeRenderer) { 
                threeRenderer.setSize(threeJsCanvasContainer.clientWidth, threeJsCanvasContainer.clientHeight);
                threeCamera.aspect = threeJsCanvasContainer.clientWidth / threeJsCanvasContainer.clientHeight;
                threeCamera.updateProjectionMatrix();
            }
        });

    </script>
</body>
</html>
